<!doctype html>

<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Scan QR</title>
  <script type="text/javascript" src="lib/instascan.min.js"></script>
  <script type="text/javascript" src="assets/js/toast.js"></script>
  <script type="text/javascript" src="assets/js/scan.js"></script>
  <link href="assets/css/scan-style.css" rel="stylesheet" />
</head>

<body>
  <nav hidden>
    <div class="title-bar" onclick="toggleNav(event)">
      <h3 style="padding-left: 1em;">Menu</h3>
    </div>
    <div class="flex scroll">
      <ul>
        <li><strong>Camera</strong></li>
        <li>
          <select class="js-camera-options">
         <option>Select Camera</option>
        </select>
        </li>
        <hr />
        <li><strong>Data</strong></li>
        <li><button onclick="clearLog(); log(store.listScans().map(JSON.stringify).join('\n')); toggleNav(event);">list</button></li>
        <li><button onclick="exportCSV()">Export CSV</button></li>
        <li><button onclick="clearLog(); store.purge();" class="button-purge">purge</button></li>

        <hr/>
        <li><strong>Display</strong></li>
        <li><button onclick="document.body.requestFullscreen()">Full Screen</button>
      </ul>
    </div>
  </nav>

  <div class="js-toast" hidden>
    toast!
  </div>





  <div class="content-wrapper">
    <div class="title-bar">
      <h3 onclick="toggleNav(event);" style="padding-left: 1em;">Spartans QR</h3>
    </div>

    <div class="js-content content">
      <div style="text-align: center; margin: 1em;">
        <video id="preview"></video>
      </div>
      <div class="with-margin with-border-top">
        <pre id="log"></pre>
      </div>
      <hr />
    </div>

    <div class="js-config content" hidden>
      <h3>Configure</h3>


      <button onclick="toggleConfig(event);">X</button>
    </div>


    <div class="action-bar">
      <button class="js-button-scan" onclick="optics.scan();">scan</button>
      <button class="js-button-stop-scan" onclick="optics.stopScan();" hidden>stop</button>

      <button onclick="clearLog();"> Clear</button>

      <!-- <button onclick="log('log')">log</button> -->

    </div>

  </div>



  <script type="text/javascript">
    const optics = {
      scanner: undefined,
      camera: undefined,

      scan: () => {
        if (optics.scanner && optics.camera) {
          optics.scanner.start(optics.camera);
          document.querySelector('.js-button-scan').setAttribute('hidden', true);
          document.querySelector('.js-button-stop-scan').removeAttribute('hidden');
        } else {
          alert('please select a camera!');
        }
      },

      stopScan: () => {
        if (optics.scanner) {
          optics.scanner.stop();
          document.querySelector('.js-button-stop-scan').setAttribute('hidden', true);
          document.querySelector('.js-button-scan').removeAttribute('hidden');
        }
      },

      selectCamera: (targetCamera) => {
        Instascan.Camera.getCameras()
          .then(function(cameras) {
            let camToUse = cameras.filter(cam => cam.id === targetCamera)[0];
            optics.camera = camToUse;
            if (camToUse) {
              optics.camera = camToUse;
              store.saveCameraId(camToUse.id);
            } else {
              alert('No usable camera found.');
            }
          }).catch(function(e) {
            log(`error: ${e}`);
          });
      }
    };

    const scanState = {
      seq: null,
      id: null,
      name: null,
      complete: () => !!(scanState.seq && scanState.id && scanState.name),
      reset: () => {
        scanState.seq = null;
        scanState.id = null;
        scanState.name = null;
      },
      capture: () => {
        let scan = {
          id: scanState.id,
          name: scanState.name,
          seq: scanState.seq,
          timestamp: new Date().toISOString()
        };
        store.addScan(scan);

        log(`scan captured: (${scan.seq}) ${scan.name}`);

        scanState.reset();
      }
    }

    const onScan = (content) => {
      optics.stopScan();
      if (content && content.indexOf(':') > -1) {
        // id
        let parts = content.split(':').map(x => (x || '').trim());
        scanState.id = (parts[1] || '');
        scanState.name = (parts[0] || '');
        Toast.show(`Name: ${scanState.name}`);
        log(`Name: ${scanState.name}`);
      } else if (content) {
        // seq
        scanState.seq = Number(content.trim());
        Toast.show(`Seq: ${scanState.seq}`);
      }
      if (scanState.complete()) {
        // capture scan
        scanState.capture();
      } else {
        Toast.show('now scan: ' + (scanState.id ? 'sequence token' : 'user token'));
      }
    };

    const clearLog = () => document.querySelector('#log').innerHTML = '';

    optics.scanner = new Instascan.Scanner({
      video: document.getElementById('preview'),
      mirror: false
    });
    optics.scanner.addListener('scan', onScan);

    setTimeout(() => log('scan user or sequence token.'), 500);

    let camSelect = document.querySelector('select.js-camera-options');
    camSelect.addEventListener('change', e => {
      console.info('camera changed', e);
      let targetCamera = e.target.value;

      optics.selectCamera(targetCamera);
    });

    Instascan.Camera.getCameras()
      .then(cameras => {
        cameras.forEach(camera => {
          let camOption = document.createElement('option');
          camOption.value = camera.id;
          camOption.text = camera.name || 'no name';
          camSelect.appendChild(camOption);
        });

        console.info('cameraid: ', store.getCameraId());

        if (store.getCameraId()) {
          camSelect.value = store.getCameraId();
          optics.selectCamera(store.getCameraId());
        }
      });

    Toast.hookup('.js-toast');
  </script>
</body>

</html>
