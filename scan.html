<!doctype html>

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>Scan QR</title>
    <script type="text/javascript" src="lib/instascan.min.js"></script>
    <style>
      video {
        width: 33%;
      }
      button {
        border-radius: 0.3em;
        box-shadow: 0px 0px 5px 0px;
        padding: 0.7em;
        font-size: 14pt;
      }
    </style>
  </head>
  <body>
    <h3>Scan QR</h3>
    <video id="preview"></video>
    <button onclick="optics.scan();">scan</button>
    <button onclick="clearLog();">clear</button>
    <button onclick="log(JSON.stringify(store.listScans()));">list</button>
    <pre id="log"></pre>
    <script type="text/javascript">

    const store = {
      listScans: () => JSON.parse(localStorage.scans || '[]'),
      addScan: (scan) => {
        let scans = store.listScans();
        scans.push(scan);
        localStorage.scans = JSON.stringify(scans);
        return {
          scan: scan,
          scanCount: scans.length
        };
      }
    };

    const optics = {
      scanner: undefined,
      camera: undefined,

      scan: () => {
        if (optics.scanner) {
          optics.scanner.start(optics.camera);
          //setTimeout(() => optics.scanner.stop(), 3000);
        }
      }
    };

    const scanState = {
      seq: undefined,
      id: undefined,
      complete: () => !!(scanState.seq && scanState.id),
      reset: () => {
        log(`scanState reset: ${JSON.stringify(scanState)}`);
        scanState.seq = undefined;
        scanState.id = undefined;
      },
      capture: () => {
        store.addScan({
          id: scanState.id,
          seq: scanState.seq,
          timestamp: new Date().toISOString()
        });

        scanState.reset();
      }
    }

    const onScan = (content) => {
      optics.scanner.stop();
      log(`scan: ${content}`);
      if (content && content.indexOf(':') > -1) {
        // id
        scanState.id = content;
      } else if (content) {
        // seq
        scanState.seq = content;
      }
      if (scanState.complete()) {
        // capture scan
        scanState.capture();
        log('scans: ' + JSON.stringify(store.listScans()));
        log('scan captured. next!');
      } else {
        log('now scan: ' + (scanState.id ? 'sequence token' : 'user token'));
      }
    };

      const log = (msg) => {
        console.log('got msg: ', msg);
        let loge = document.querySelector('#log');
        loge.innerHTML = msg + "\n" + loge.innerHTML;
      }

      const clearLog = () => document.querySelector('#log').innerHTML = '';

      optics.scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false});
      optics.scanner.addListener('scan', onScan);

      Instascan.Camera.getCameras()
        .then(function (cameras) {
          let camToUse = cameras.filter(cam => cam.name && (cam.name.indexOf('back') > -1 || cam.name.indexOf('FaceTime') > -1))[0];
          optics.camera = camToUse;
          if (camToUse) {
            //optics.scanner.start(camToUse);
            optics.camera = camToUse;
          } else {
            alert('No usable camera found.');
          }
        }).catch(function (e) {
          log(`error: ${e}`);
        });

      Instascan.Camera.getCameras()
        .then(x => x.reduce((acc, cam) => {
          acc += JSON.stringify(cam);
          return acc;
        }, ''))
        .then(found => log(`cameras found: ${found}`));

        setTimeout(() => log('scan user or sequence token.'), 500);

    </script>
  </body>
</html>
